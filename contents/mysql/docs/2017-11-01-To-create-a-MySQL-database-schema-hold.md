---
layout: post
title: "打造扛得住的MySQL数据库架构"
date: 2017-11-01 08:21:49
categories: MySQL
tags: MySQL
---


打造扛得住的MySQL数据库架构

# 影响数据库性能的原因

1. QPS和TPS
2. 高并发
3. 磁盘IO
4. 网卡IO
5. 大表
6. 大事务



## 超高的QPS和TPS

MySQL不支持多CPU并发运算

## 大量的并发和超高的CPU使用率

风险：

1. 大量的并发：数据库连接数被占满(max_connections默认100)
2. 超高的CPU使用率：因CPU资源耗尽而出现宕机

## 磁盘IO

风险：

1. 磁盘IO性能突然下降，使用更快的磁盘设备
2. 其他大量消耗磁盘性能的计划任务，调整计划任务，做好磁盘维护

## 网卡流量

如何避免无法连接数据库的情况：

1. 减少从服务器的数量 
2. 进行分级缓存 
3. 避免使用`select *`进行查询
4. 分离业务网络和服务器网络

## 大表对DDL操作的影响

什么样的表可以称为大表

1. 记录行数巨大，单表超过千万行
2. 表数据文件巨大，表数据文件超过10G

大表对查询的影响：

1. 慢查询：

建立 索引需要很长的时间

1. MySQL版本<5.5建立索引会锁表
2. MySQL版本>=5.5 虽然不会锁表但会引起主从延迟

修改表结构需要长时间锁表

1. 会造成长时间的主从延迟
2. 影响正常的数据操作



## 如何处理数据库中的大表

1. 分库分表把一张大表分成多个小表

   难点：

   1. 分表主键的选择
   2. 分表后跨分区数据的查询和统计

2. 大表的历史数据归档

   减少对前后端业务的影响

   难点：

   1. 归档时间点的选择
   2. 如何进行归档操作



## 什么是事务

1. 原子性
2. 一致性 
3. 隔离性 隔离性由低到高，并发性由高到低
   1. 未提交读 read uncommited
   2. 已提交读 read commited
   3. 可重复读 repeatable read
   4. 可串行化 serializable
4. 持久性 

```sql
-- 查看数据库事务隔离级别
show variables like '%iso';

-- 启动事务
begin;

-- 提交事务
commit;


```

## 什么是大事务

运行时间比较长，操作的数据比较多的事务

风险：

1. 锁定太多的数据，造成大量的阻塞和锁超时
2. 回滚时所需时间比较长
3. 执行时间长，容易造成主从延迟

## 如何处理大事务

1. 避免一次处理太多的数据
2. 移出不必要在事务中的select操作

# 影响因素





